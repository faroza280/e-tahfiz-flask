<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Wali Santri - E-Tahfizh</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .hero-section { background: linear-gradient(135deg, #198754 0%, #20c997 100%); color: white; padding: 3rem 1rem; border-radius: 0 0 30px 30px; margin-bottom: 2rem; }
        .card-custom { border: none; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: transform 0.2s; }
        .card-custom:hover { transform: translateY(-3px); }
        .icon-box { width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; border-radius: 12px; margin-right: 1rem; }
        .bg-soft-success { background-color: #d1e7dd; color: #0f5132; }
        .bg-soft-primary { background-color: #cfe2ff; color: #084298; }
        .bg-soft-warning { background-color: #fff3cd; color: #664d03; }
    </style>
</head>
<body>

    <!-- Header / Pencarian -->
    <div class="hero-section text-center">
        <h2 class="fw-bold mb-2"><i class="fas fa-quran me-2"></i>Portal Wali Santri</h2>
        <p class="opacity-75 mb-4">Pantau perkembangan hafalan putra-putri Anda</p>
        
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <form action="{{ url_for('portal_wali') }}" method="GET" class="card p-2 border-0 shadow-lg rounded-pill">
                        <div class="input-group">
                            <input type="text" name="keyword" class="form-control border-0 rounded-pill ps-4" 
                                   placeholder="Masukkan Nama Lengkap Santri..." value="{{ keyword if keyword else '' }}" required>
                            <button class="btn btn-success rounded-pill px-4 fw-bold" type="submit">
                                <i class="fas fa-search me-2"></i> Cari
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Konten Utama -->
    <div class="container pb-5">
        
        <!-- Menampilkan Pesan Flash (Jika Santri Tidak Ditemukan) -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                <div class="alert alert-{{ category }} text-center rounded-4 shadow-sm mb-4" role="alert">
                    {{ message }}
                </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {% if santri %}
        <!-- 1. Profil Singkat & Aksi Laporan -->
        <div class="row mb-4">
            <div class="col-12 text-center">
                <div class="d-inline-block p-1 border border-3 border-white rounded-circle shadow">
                    {% if santri.foto %}
                        <img src="{{ url_for('static', filename='uploads/' + santri.foto) }}" alt="Foto" class="rounded-circle" width="100" height="100">
                    {% else %}
                        <!-- Avatar Generator otomatis berdasarkan nama -->
                        <img src="https://ui-avatars.com/api/?name={{ santri.nama }}&background=198754&color=fff&size=128" alt="Avatar" class="rounded-circle" width="100" height="100">
                    {% endif %}
                </div>
                <h3 class="mt-3 fw-bold text-dark">{{ santri.nama }}</h3>
                <p class="text-muted mb-3"><i class="fas fa-chalkboard-teacher me-1"></i> Kelas: {{ santri.kelas }}</p>

                <!-- TOMBOL AKSI LAPORAN (UPDATE) -->
                <div class="d-flex justify-content-center gap-2">
                    <!-- Tombol Cetak Rapor -->
                    <a href="{{ url_for('cetak_laporan', santri_id=santri.id) }}" target="_blank" class="btn btn-outline-dark rounded-pill">
                        <i class="fas fa-print me-1"></i> Cetak Rapor
                    </a>
                    
                    <!-- Tombol Lapor WA dengan Link Rapor -->
                    <!-- _external=True akan menghasilkan link lengkap (http://domain/...) -->
                    {% set rapor_url = url_for('cetak_laporan', santri_id=santri.id, _external=True) %}
                    
                    <!-- Kita gunakan %0A untuk Baris Baru (Enter) di link WhatsApp -->
                    {% set wa_text = "Assalamu'alaikum Wr. Wb.%0A%0ABerikut Laporan Capaian Belajar Santri:%0ANama: " + santri.nama + "%0AKelas: " + santri.kelas + "%0A%0ARingkasan:%0A- Total Setoran: " + summary.total_setoran|string + "x%0A- Kehadiran: " + summary.hadir|string + " hari%0A%0ASilakan klik tautan berikut untuk melihat RAPOR LENGKAP:%0A" + rapor_url + "%0A%0AMohon doanya untuk ananda agar istiqomah. Terima kasih." %}
                    
                    <a href="https://wa.me/?text={{ wa_text }}" target="_blank" class="btn btn-success rounded-pill">
                        <i class="fab fa-whatsapp me-1"></i> Kirim Rapor via WA
                    </a>
                </div>
            </div>
        </div>

        <!-- 2. Kartu Statistik -->
        <div class="row g-3 mb-4">
            <div class="col-6 col-md-3">
                <div class="card card-custom p-3 h-100">
                    <div class="d-flex align-items-center">
                        <div class="icon-box bg-soft-success"><i class="fas fa-book-open fs-4"></i></div>
                        <div>
                            <small class="text-muted d-block">Total Setoran</small>
                            <span class="fw-bold fs-5">{{ summary.total_setoran }}x</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card card-custom p-3 h-100">
                    <div class="d-flex align-items-center">
                        <div class="icon-box bg-soft-primary"><i class="fas fa-check-circle fs-4"></i></div>
                        <div>
                            <small class="text-muted d-block">Kehadiran</small>
                            <span class="fw-bold fs-5">{{ summary.hadir }} Hari</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card card-custom p-3 h-100">
                    <div class="d-flex align-items-center">
                        <div class="icon-box bg-soft-warning"><i class="fas fa-procedures fs-4"></i></div>
                        <div>
                            <small class="text-muted d-block">Sakit</small>
                            <span class="fw-bold fs-5">{{ summary.sakit }} Hari</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card card-custom p-3 h-100">
                    <div class="d-flex align-items-center">
                        <div class="icon-box bg-danger bg-opacity-10 text-danger"><i class="fas fa-times-circle fs-4"></i></div>
                        <div>
                            <small class="text-muted d-block">Alpha</small>
                            <span class="fw-bold fs-5">{{ summary.alpha }} Hari</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- 3. Tabel Riwayat Setoran -->
            <div class="col-lg-7 mb-4">
                <div class="card card-custom h-100">
                    <div class="card-header bg-white border-bottom-0 pt-4 px-4">
                        <h5 class="fw-bold mb-0 text-success"><i class="fas fa-history me-2"></i>Riwayat Hafalan Terakhir</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>Tanggal</th>
                                        <th>Surat & Ayat</th>
                                        <th>Kualitas</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for s in setoran %}
                                    <tr>
                                        <td class="small text-muted">{{ s.tanggal.strftime('%d %b %Y') }}</td>
                                        <td>
                                            <span class="fw-bold d-block text-dark">{{ s.surat }}</span>
                                            <small class="text-muted">Ayat {{ s.ayat_awal }}-{{ s.ayat_akhir }}</small>
                                        </td>
                                        <td>
                                            <span class="badge rounded-pill bg-{{ 'success' if s.kualitas == 'Mumtaz' or s.kualitas == 'Lancar' else 'warning' }}">
                                                {{ s.kualitas }}
                                            </span>
                                        </td>
                                    </tr>
                                    {% else %}
                                    <tr><td colspan="3" class="text-center py-4 text-muted">Belum ada data setoran.</td></tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 4. Tabel Riwayat Absensi -->
            <div class="col-lg-5 mb-4">
                <div class="card card-custom h-100">
                    <div class="card-header bg-white border-bottom-0 pt-4 px-4">
                        <h5 class="fw-bold mb-0 text-primary"><i class="fas fa-calendar-check me-2"></i>Riwayat Kehadiran</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>Tanggal</th>
                                        <th>Ket</th>
                                        <th class="text-end">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for a in absensi %}
                                    <tr>
                                        <td class="small text-muted">{{ a.tanggal.strftime('%d %b %Y') }}</td>
                                        <td class="small text-muted">{{ a.keterangan if a.keterangan else '-' }}</td>
                                        <td class="text-end">
                                            {% if a.status == 'Hadir' %}
                                                <span class="badge bg-success rounded-pill">Hadir</span>
                                            {% elif a.status == 'Sakit' %}
                                                <span class="badge bg-warning text-dark rounded-pill">Sakit</span>
                                            {% elif a.status == 'Izin' %}
                                                <span class="badge bg-info text-dark rounded-pill">Izin</span>
                                            {% else %}
                                                <span class="badge bg-danger rounded-pill">Alpha</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% else %}
                                    <tr><td colspan="3" class="text-center py-4 text-muted">Belum ada data absensi.</td></tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {% else %}
        <!-- Tampilan Awal (Kosong) -->
        <div class="text-center mt-5 opacity-50">
            <i class="fas fa-search fa-4x mb-3 text-secondary"></i>
            <h4>Silakan cari nama santri untuk melihat data</h4>
        </div>
        {% endif %}
        
        <div class="text-center mt-5 text-muted small">
            &copy; 2025 E-Tahfizh KKN. All Rights Reserved.
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>